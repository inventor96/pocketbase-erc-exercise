{{define "title"}}
ERC Exercise Admin
{{end}}

{{define "container"}}
<div class="row">
	<div class="col">
		<h1>ERC Exercise Admin</h1>
	</div>
	<div class="col-auto text-end">
		<a href="/monitor" target="_blank" class="btn btn-primary">
			Monitor
			<i class="ms-1 bi bi-box-arrow-up-right"></i>
		</a>
	</div>
</div>

<!-- exercises table -->
<div class="card mb-5">
	<div class="card-body">
		<div class="row">
			<div class="col">
				<h4 class="card-title">Exercises</h4>
			</div>
			<div class="col text-end">
				<a href="/admin/exercise/new" class="btn btn-success">New Exercise</a>
			</div>
		</div>
		
		<table class="table table-striped table-hover mb-0">
			<thead>
				<tr>
					<th>Name</th>
					<th>Start</th>
					<th>End</th>
					<th>Started</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody id="exercise-list">
				<tr>
					<td colspan="5" class="text-center">
						<div class="d-flex justify-content-center align-items-center">
							<div class="spinner-border me-2" role="status" aria-hidden="true"></div>
							<span>loading...</span>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>

<!-- regions table -->
<div class="card mb-5">
	<div class="card-body">
		<div class="row">
			<div class="col">
				<h4 class="card-title">Regions</h4>
			</div>
			<div class="col text-end">
				<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#region_modal" data-bs-name="" data-bs-id="">New Region</button>
			</div>
		</div>
		<table class="table table-striped table-hover mb-0">
			<thead>
				<tr>
					<th>Name</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody id="region-list">
				<tr>
					<td colspan="2" class="text-center">
						<div class="d-flex justify-content-center align-items-center">
							<div class="spinner-border me-2" role="status" aria-hidden="true"></div>
							<span>loading...</span>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>

<!-- stakes table -->
<div class="card mb-5">
	<div class="card-body">
		<div class="row">
			<div class="col">
				<h4 class="card-title">Stakes</h4>
			</div>
			<div class="col text-end">
				<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#stake_modal" data-bs-name="" data-bs-id="" data-bs-region="">New Stake</button>
			</div>
		</div>
		<table class="table table-striped table-hover mb-0">
			<thead>
				<tr>
					<th>Name</th>
					<th>Region</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody id="stake-list">
				<tr>
					<td colspan="3" class="text-center">
						<div class="d-flex justify-content-center align-items-center">
							<div class="spinner-border me-2" role="status" aria-hidden="true"></div>
							<span>loading...</span>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>

<!-- action confirmation modal -->
<div class="modal fade" id="confirm_modal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Are you sure?</h4>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>Are you sure you want to <span id="action_name"></span> the "<span id="exercise_name"></span>" <span id="collection_name"></span>?</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" id="action_confirm" class="btn btn-primary" data-bs-dismiss="modal" data-bs-collection="" data-bs-id="">Yes</button>
			</div>
		</div>
	</div>
</div>

<!-- create/edit region modal -->
<div class="modal fade" id="region_modal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><span id="region_modal_title">Edit</span> Region</h4>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form id="region_form">
					<div class="mb-4">
						<label for="region_name" class="form-label fs-5 fw-bold">Name</label>
						<input type="text" class="form-control" id="region_name" name="region_name" required minlength="3">
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" id="region_confirm" class="btn btn-primary" data-bs-dismiss="modal" data-bs-id="">Save</button>
			</div>
		</div>
	</div>
</div>

<!-- create/edit stake modal -->
<div class="modal fade" id="stake_modal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title"><span id="stake_modal_title">Edit</span> Stake</h4>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<form id="stake_form">
					<div class="mb-4">
						<label for="stake_name" class="form-label fs-5 fw-bold">Name</label>
						<input type="text" class="form-control" id="stake_name" name="stake_name" required minlength="3">
					</div>
					<div class="mb-4">
						<label for="stake_region" class="form-label fs-5 fw-bold">Region</label>
						<select class="form-select" id="stake_region" name="stake_region" required>
							<option value="" disabled selected>Select a region</option>
						</select>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" id="stake_confirm" class="btn btn-primary" data-bs-dismiss="modal" data-bs-id="">Save</button>
			</div>
		</div>
	</div>
</div>
{{end}}

{{define "script"}}
<script type="text/javascript">
	$(() => {
		// update list of exercises
		function updateExercises(exercises) {
			const tbody = $('#exercise-list');
			tbody.empty();

			pb.collection('exercises').getFullList({sort: '-start', requestKey: 'exercises'}).then(exercises => {
				// check if the exercises array is empty
				if (exercises.length === 0) {
					tbody.append(`
						<tr>
							<td colspan="5" class="text-center">
								<div class="d-flex justify-content-center align-items-center">
									<span>No exercises found</span>
								</div>
							</td>
						</tr>
					`);
					return;
				}

				// loop through the exercises and create a table row for each
				exercises.forEach(exercise => {
					const tr = $(`
						<tr>
							<td class="align-middle fw-bold">${exercise.name}</td>
							<td class="align-middle">${new Date(exercise.start).toLocaleString()}</td>
							<td class="align-middle">${new Date(exercise.end).toLocaleString()}</td>
							<td class="align-middle">${exercise.started ? '<span class="fs-6 badge text-bg-success">Started</span>' : '<span class="fs-6 badge text-bg-warning">Not Started</span>'}</td>
							<td class="align-middle">
								${exercise.started ? 
									`<button type="button" class="btn btn-danger m-1" data-bs-toggle="modal" data-bs-target="#confirm_modal" data-bs-collection="exercise" data-bs-id="${exercise.id}" data-bs-name="${exercise.name}" data-bs-action="stop">Stop</button>` : 
									`<button type="button" class="btn btn-success m-1" data-bs-toggle="modal" data-bs-target="#confirm_modal" data-bs-collection="exercise" data-bs-id="${exercise.id}" data-bs-name="${exercise.name}" data-bs-action="start">Start</button>`
								}
								<a href="/admin/exercise/${exercise.id}" class="btn btn-primary m-1">View/Edit</a>
								<button type="button" class="btn btn-danger m-1" data-bs-toggle="modal" data-bs-target="#confirm_modal" data-bs-collection="exercise" data-bs-id="${exercise.id}" data-bs-name="${exercise.name}" data-bs-action="delete">Delete</button>
							</td>
						</tr>
					`);
					tbody.append(tr);
				});
			}).catch(err => {
				console.error('Error fetching exercises:', err);
				tbody.append(`
					<tr>
						<td colspan="5" class="text-center">
							<div class="d-flex justify-content-center align-items-center">
								<span>Error loading exercises</span>
							</div>
						</td>
					</tr>
				`);
			});
		}
		updateExercises();
		pb.collection('exercises').subscribe('*', updateExercises);

		// update list of regions
		function updateRegions() {
			const tbody = $('#region-list');
			tbody.empty();

			pb.collection('regions').getFullList({sort: 'name', requestKey: 'regions'}).then(regions => {
				// check if the regions array is empty
				if (regions.length === 0) {
					tbody.append(`
						<tr>
							<td colspan="2" class="text-center">
								<div class="d-flex justify-content-center align-items-center">
									<span>No regions found</span>
								</div>
							</td>
						</tr>
					`);
					return;
				}

				// loop through the regions and create a table row for each
				regions.forEach(region => {
					const tr = $(`
						<tr>
							<td class="align-middle fw-bold">${region.name}</td>
							<td class="align-middle">
								<button type="button" class="btn btn-primary m-1" data-bs-toggle="modal" data-bs-target="#region_modal" data-bs-collection="region" data-bs-id="${region.id}" data-bs-name="${region.name}">Edit</button>
								<button type="button" class="btn btn-danger m-1" data-bs-toggle="modal" data-bs-target="#confirm_modal" data-bs-collection="region" data-bs-id="${region.id}" data-bs-name="${region.name}" data-bs-action="delete">Delete</button>
							</td>
						</tr>
					`);
					tbody.append(tr);
				});

				// loop through the regions and create a select option for each
				const stakeRegionSelect = $('#stake_region');
				stakeRegionSelect.empty();
				stakeRegionSelect.append('<option value="" disabled selected>Select a region</option>');
				regions.forEach(region => {
					const option = $(`
						<option value="${region.id}">${region.name}</option>
					`);
					stakeRegionSelect.append(option);
				});
			}).catch(err => {
				console.error('Error fetching regions:', err);
				tbody.append(`
					<tr>
						<td colspan="2" class="text-center">
							<div class="d-flex justify-content-center align-items-center">
								<span>Error loading regions</span>
							</div>
						</td>
					</tr>
				`);
			});
		}
		updateRegions();
		pb.collection('regions').subscribe('*', updateRegions);

		// update list of stakes
		function updateStakes() {
			const tbody = $('#stake-list');
			tbody.empty();

			pb.collection('stakes').getFullList({
				sort: 'name',
				requestKey: 'stakes',
				expand: 'region',
			}).then(stakes => {
				// check if the stakes array is empty
				if (stakes.length === 0) {
					tbody.append(`
						<tr>
							<td colspan="3" class="text-center">
								<div class="d-flex justify-content-center align-items-center">
									<span>No stakes found</span>
								</div>
							</td>
						</tr>
					`);
					return;
				}

				// loop through the stakes and create a table row for each
				stakes.forEach(stake => {
					const tr = $(`
						<tr>
							<td class="align-middle fw-bold">${stake.name}</td>
							<td class="align-middle">${stake.expand.region.name}</td>
							<td class="align-middle">
								<button type="button" class="btn btn-primary m-1" data-bs-toggle="modal" data-bs-target="#stake_modal" data-bs-collection="stake" data-bs-id="${stake.id}" data-bs-name="${stake.name}" data-bs-region="${stake.region}">Edit</button>
								<button type="button" class="btn btn-danger m-1" data-bs-toggle="modal" data-bs-target="#confirm_modal" data-bs-collection="stake" data-bs-id="${stake.id}" data-bs-name="${stake.name}" data-bs-action="delete">Delete</button>
							</td>
						</tr>
					`);
					tbody.append(tr);
				});
			}).catch(err => {
				console.error('Error fetching stakes:', err);
				tbody.append(`
					<tr>
						<td colspan="3" class="text-center">
							<div class="d-flex justify-content-center align-items-center">
								<span>Error loading stakes</span>
							</div>
						</td>
					</tr>
				`);
			});
		}
		updateStakes();
		pb.collection('stakes').subscribe('*', updateStakes);

		// confirm exercise action
		$('#confirm_modal').on('show.bs.modal', function (event) {
			// get data from the button that triggered the modal
			const button = $(event.relatedTarget);
			const action = button.data('bs-action');
			const collection = button.data('bs-collection');
			const objectId = button.data('bs-id');
			const objectName = button.data('bs-name');

			// update the modal's content
			const modal = $(this);
			modal.find('#action_name').text(action);
			modal.find('#exercise_name').text(objectName);
			modal.find('#collection_name').text(collection);
			modal.find('#action_confirm')
				.data('bs-id', objectId)
				.data('bs-collection', collection)
				.data('bs-action', action);
		});
		$('#action_confirm').on('click', function () {
			const objectId = $(this).data('bs-id');
			const collection = $(this).data('bs-collection') + 's';
			const action = $(this).data('bs-action');

			// starting an exercise
			if (action === 'start' && collection === 'exercises') {
				pb.collection('exercises').update(objectId, { started: true })
					.catch(err => {
						console.error('Error starting exercise:', err);
						alert(`Error starting exercise: ${err.message}`);
					});
			// stopping an exercise
			} else if (action === 'stop' && collection === 'exercises') {
				pb.collection('exercises').update(objectId, { started: false })
					.catch(err => {
						console.error('Error stopping exercise:', err);
						alert(`Error stopping exercise: ${err.message}`);
					});
			// deleting an object
			} else if (action === 'delete') {
				pb.collection(collection).delete(objectId)
					.catch(err => {
						console.error('Error deleting exercise:', err);
						alert(`Error deleting exercise: ${err.message}`);
					});
			}
		});

		// handle region modal
		$('#region_modal').on('show.bs.modal', function (event) {
			// get data from the button that triggered the modal
			const button = $(event.relatedTarget);
			const regionId = button.data('bs-id');
			const regionName = button.data('bs-name');

			// update the modal's content
			const modal = $(this);
			modal.find('#region_name').val(regionName);
			modal.find('#region_confirm').data('bs-id', regionId);
			modal.find('#region_modal_title').text(regionId ? 'Edit' : 'New');
		});
		$('#region_confirm').on('click', function () {
			const regionId = $(this).data('bs-id');
			const regionName = $('#region_name').val();

			// update existing region
			if (regionId) {
				pb.collection('regions').update(regionId, { name: regionName })
					.catch(err => {
						console.error('Error updating region:', err);
						alert(`Error updating region: ${err.message}`);
					});
			// create new region
			} else {
				pb.collection('regions').create({ name: regionName })
					.catch(err => {
						console.error('Error creating region:', err);
						alert(`Error creating region: ${err.message}`);
					});
			}
		});

		// handle stake modal
		$('#stake_modal').on('show.bs.modal', function (event) {
			// get data from the button that triggered the modal
			const button = $(event.relatedTarget);
			const stakeId = button.data('bs-id');
			const stakeName = button.data('bs-name');
			const stakeRegion = button.data('bs-region');

			// update the modal's content
			const modal = $(this);
			modal.find('#stake_name').val(stakeName);
			modal.find('#stake_region').val(stakeRegion);
			modal.find('#stake_confirm').data('bs-id', stakeId);
			modal.find('#stake_modal_title').text(stakeId ? 'Edit' : 'New');
		});
		$('#stake_confirm').on('click', function () {
			const stakeId = $(this).data('bs-id');
			const stakeName = $('#stake_name').val();
			const stakeRegion = $('#stake_region').val();

			// update existing stake
			if (stakeId) {
				pb.collection('stakes').update(stakeId, { name: stakeName, region: stakeRegion })
					.catch(err => {
						console.error('Error updating stake:', err);
						alert(`Error updating stake: ${err.message}`);
					});
			// create new stake
			} else {
				pb.collection('stakes').create({ name: stakeName, region: stakeRegion })
					.catch(err => {
						console.error('Error creating stake:', err);
						alert(`Error creating stake: ${err.message}`);
					});
			}
		});
	})
</script>
{{end}}