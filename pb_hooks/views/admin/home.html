{{define "title"}}
ERC Exercise Admin
{{end}}

{{define "container"}}
<div class="row">
	<div class="col">
		<h1>ERC Exercise Admin</h1>
	</div>
	<div class="col-auto text-end">
		<a href="/monitor" target="_blank" class="btn btn-primary">
			Monitor
			<i class="ms-1 bi bi-box-arrow-up-right"></i>
		</a>
	</div>
</div>

<div class="card mb-5">
	<div class="card-body">
		<div class="row">
			<div class="col">
				<h4 class="card-title">Exercises</h4>
			</div>
			<div class="col text-end">
				<a href="/admin/exercise/new" class="btn btn-success">New Exercise</a>
			</div>
		</div>
		
		<table class="table table-striped table-hover mb-0">
			<thead>
				<tr>
					<th>Name</th>
					<th>Start</th>
					<th>End</th>
					<th>Started</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody id="exercise-list">
				<tr>
					<td colspan="5" class="text-center">
						<div class="d-flex justify-content-center align-items-center">
							<div class="spinner-border me-2" role="status" aria-hidden="true"></div>
							<span>loading...</span>
						</div>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
</div>

<div class="modal fade" id="confirm_modal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Are you sure?</h4>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>Are you sure you want to <span id="action_name"></span> the "<span id="exercise_name"></span>" exercise?</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" id="action_confirm" class="btn btn-primary" data-bs-dismiss="modal" data-bs-id="">Yes</button>
			</div>
		</div>
	</div>
</div>
{{end}}

{{define "script"}}
<script type="text/javascript">
	$(() => {
		// update list of exercises
		function updateExercises(exercises) {
			const tbody = $('#exercise-list');
			tbody.empty();

			pb.collection('exercises').getFullList({sort: '-start', requestKey: 'exercises'}).then(exercises => {
				// check if the exercises array is empty
				if (exercises.length === 0) {
					tbody.append(`
						<tr>
							<td colspan="5" class="text-center">
								<div class="d-flex justify-content-center align-items-center">
									<span>No exercises found</span>
								</div>
							</td>
						</tr>
					`);
					return;
				}

				// loop through the exercises and create a table row for each
				exercises.forEach(exercise => {
					const tr = $(`
						<tr>
							<td class="align-middle fw-bold">${exercise.name}</td>
							<td class="align-middle">${new Date(exercise.start).toLocaleString()}</td>
							<td class="align-middle">${new Date(exercise.end).toLocaleString()}</td>
							<td class="align-middle">${exercise.started ? '<span class="fs-6 badge text-bg-success">Started</span>' : '<span class="fs-6 badge text-bg-warning">Not Started</span>'}</td>
							<td class="align-middle">
								${exercise.started ? 
									`<button type="button" class="btn btn-danger m-1" data-bs-toggle="modal" data-bs-target="#confirm_modal" data-bs-id="${exercise.id}" data-bs-name="${exercise.name}" data-bs-action="stop">Stop</button>` : 
									`<button type="button" class="btn btn-success m-1" data-bs-toggle="modal" data-bs-target="#confirm_modal" data-bs-id="${exercise.id}" data-bs-name="${exercise.name}" data-bs-action="start">Start</button>`
								}
								<a href="/admin/exercise/${exercise.id}" class="btn btn-primary m-1">View/Edit</a>
								<button type="button" class="btn btn-danger m-1" data-bs-toggle="modal" data-bs-target="#confirm_modal" data-bs-id="${exercise.id}" data-bs-name="${exercise.name}" data-bs-action="delete">Delete</button>
							</td>
						</tr>
					`);
					tbody.append(tr);
				});
			}).catch(err => {
				console.error('Error fetching exercises:', err);
				tbody.append(`
					<tr>
						<td colspan="5" class="text-center">
							<div class="d-flex justify-content-center align-items-center">
								<span>Error loading exercises</span>
							</div>
						</td>
					</tr>
				`);
			});
		}
		updateExercises();
		pb.collection('exercises').subscribe('*', updateExercises);

		// confirm action
		$('#confirm_modal').on('show.bs.modal', function (event) {
			const button = $(event.relatedTarget);
			const action = button.data('bs-action');
			const exerciseId = button.data('bs-id');
			const exerciseName = button.data('bs-name');

			const modal = $(this);
			modal.find('#action_name').text(action);
			modal.find('#exercise_name').text(exerciseName);
			modal.find('#action_confirm').data('bs-id', exerciseId);
		});
		$('#action_confirm').on('click', function () {
			const exerciseId = $(this).data('bs-id');
			const action = $('#action_name').text().toLowerCase();

			if (action === 'start') {
				pb.collection('exercises').update(exerciseId, { started: true })
					.catch(err => {
						console.error('Error starting exercise:', err);
						alert(`Error starting exercise: ${err.message}`);
					});
			} else if (action === 'stop') {
				pb.collection('exercises').update(exerciseId, { started: false })
					.catch(err => {
						console.error('Error stopping exercise:', err);
						alert(`Error stopping exercise: ${err.message}`);
					});
			} else if (action === 'delete') {
				pb.collection('exercises').delete(exerciseId)
					.catch(err => {
						console.error('Error deleting exercise:', err);
						alert(`Error deleting exercise: ${err.message}`);
					});
			}
		});
	})
</script>
{{end}}